# Cart Loading States
## Cart Feature Areas
This doc explains how the Daffodil cart loading states work, and how they can be used to create a better user experience. The cart loading states are split into different feature areas, and there are three loading states possible for each of these features: loading, mutating, and complete. The purpose of splitting loading states into feature areas is to allow the app developer to show a loading state only for the parts of the cart that are actually changing rather than showing the entire cart as loading every time a user updates any part of the cart. Additionally, for the case that the app developer does want to show a loading state when anything related to the cart changes, the cart state library provides `featureLoading`, `featureMutating`, and `featureResolving`.

## Cart Item States
There are times when the app developer not only wants to show that the cart item feature area is loading, but that a particular cart item is loading or has a particular state. For example, one might want to indicate that a cart item was recently added or that a cart item whose quantity is being changed is mutating. For these use cases daffodil provides states for each cart item. The possible states for a cart item are new, mutating, updated, and default.

## Edge Cases
While we try to leave as much creative freedom as possible in the hands of the app developer, there are some edge cases for which the cart item loading state system must be strongly opinionated. The following list attempts to clarify these edge cases and how daffodil handles them:
- When a customer updates or deletes a cart item, the feature state of the cart items will remain in a `completed` state, but the individual cart item state will be go from `default` to `mutating` to `updated`. On the other hand, when a customer adds a product to the cart, the feature state of the cart items will go into a mutating state, but the cart item state will go from `default` directly to a `new` state. This is to enable the app developer to show loading states for particular cart items that are being mutated or deleted, while avoiding the complexity that comes with trying to show individual loading states for cart items being added to the cart. Some parts of this complexity are questions like: "How do I indicate to the customer that a new cart item is being added to the cart if that cart item does not exist in state until after the item has been added?" Possible to solve, but ugly. "How do I discern if a composite product being added already exists on the cart or if it will be a new cart item?" The difficulty here is that the variantId is needed to add a composite product to the cart to distinguish it from other configurations of the same composite product, but this variantId isn't returned on the DaffCompositeCartItem. The only solutions to this problem are either to require an additional field (an array of the selected options) in the DaffCartItemAdd action, or to change the backend to return the variantId associated with a composite cart item. Neither of these are particularly attractive solutions, so we elected to simply cause the entire Cart Item Feature area to load whenever a product is added to the cart.
- When a customer adds a product to the cart that already exists in the cart, the state of that cart item will become `updating` instead of `new`. This is to give precedence to how state changes rather than customer intention, because essentially all that changes is the quantity of the cart item.