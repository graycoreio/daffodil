!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@ngrx/store"),require("@angular/core"),require("@angular/common"),require("@ngrx/effects"),require("rxjs/operators"),require("rxjs"),require("@daffodil/core"),require("apollo-angular"),require("graphql-tag"),require("@daffodil/driver/magento"),require("@daffodil/driver")):"function"==typeof define&&define.amd?define("@daffodil/auth",["exports","@ngrx/store","@angular/core","@angular/common","@ngrx/effects","rxjs/operators","rxjs","@daffodil/core","apollo-angular","graphql-tag","@daffodil/driver/magento","@daffodil/driver"],e):e(((t=t||self).daffodil=t.daffodil||{},t.daffodil.auth={}),t.store,t.ng.core,t.ng.common,t.effects,t.rxjs.operators,t.rxjs,t.core$1,t.apolloAngular,t.gql,t.magento,t.driver)}(this,function(t,e,r,n,o,i,a,u,c,s,f,h){"use strict";s=s&&s.hasOwnProperty("default")?s.default:s;var l=function(t,e){return(l=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)};function p(t,e){function r(){this.constructor=t}l(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}var g=function(){return(g=Object.assign||function(t){for(var e,r=1,n=arguments.length;r<n;r++)for(var o in e=arguments[r])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t}).apply(this,arguments)};function d(t,e,r,n){var o,i=arguments.length,a=i<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var u=t.length-1;u>=0;u--)(o=t[u])&&(a=(i<3?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a}function A(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)}function v(t,e){return Object.defineProperty?Object.defineProperty(t,"raw",{value:e}):t.raw=e,t}var m={AuthGuardCheckAction:"[Daff-Auth] Auth Guard Check Action",AuthGuardCheckCompletionAction:"[Daff-Auth] Auth Guard Check Completion Action",AuthStorageFailureAction:"[Daff-Auth] Auth Storage Failure Action",AuthLoginAction:"[Daff-Auth] Auth Login Action",AuthLoginSuccessAction:"[Daff-Auth] Auth Login Success Action",AuthLoginFailureAction:"[Daff-Auth] Auth Login Failure Action",AuthLogoutAction:"[Daff-Auth] Auth Logout Action",AuthLogoutSuccessAction:"[Daff-Auth] Auth Logout Success Action",AuthLogoutFailureAction:"[Daff-Auth] Auth Logout Failure Action",AuthCheckAction:"[Daff-Auth] Auth Check Action",AuthCheckSuccessAction:"[Daff-Auth] Auth Check Success Action",AuthCheckFailureAction:"[Daff-Auth] Auth Check Failure Action",AuthRegisterAction:"[Daff-Auth] Auth Register Action",AuthRegisterSuccessAction:"[Daff-Auth] Auth Register Success Action",AuthRegisterFailureAction:"[Daff-Auth] Auth Register Failure Action"},y=function(){this.type=m.AuthGuardCheckAction};var k=function(t){this.result=t,this.type=m.AuthGuardCheckCompletionAction};var D=function(t){this.errorMessage=t,this.type=m.AuthStorageFailureAction};var S=function(t){this.loginInfo=t,this.type=m.AuthLoginAction};var I=function(t){this.auth=t,this.type=m.AuthLoginSuccessAction};var T=function(t){this.errorMessage=t,this.type=m.AuthLoginFailureAction};var w=function(){this.type=m.AuthLogoutAction};var j=function(){this.type=m.AuthLogoutSuccessAction};var b=function(t){this.errorMessage=t,this.type=m.AuthLogoutFailureAction};var E=function(){this.type=m.AuthCheckAction};var L=function(){this.type=m.AuthCheckSuccessAction};var $=function(t){this.errorMessage=t,this.type=m.AuthCheckFailureAction};var C=function(t){this.registration=t,this.type=m.AuthRegisterAction};var R=function(t){this.loginInfo=t,this.type=m.AuthRegisterSuccessAction};var F=function(t){this.errorMessage=t,this.type=m.AuthRegisterFailureAction};var O={loading:!1,errors:[]};function M(t,e){switch(void 0===t&&(t=O),e.type){case m.AuthCheckAction:return g({},t,{loading:!0});case m.AuthCheckSuccessAction:return g({},t,{loading:!1});case m.AuthCheckFailureAction:return g({},t,{loading:!1,errors:[e.errorMessage]});default:return t}}var _={auth:null,loading:!1,errors:[]};function P(t,e){switch(void 0===t&&(t=_),e.type){case m.AuthLoginAction:case m.AuthLogoutAction:return g({},t,{loading:!0});case m.AuthLoginSuccessAction:return g({},t,{loading:!1,auth:e.auth});case m.AuthLogoutSuccessAction:return g({},t,{auth:null,loading:!1});case m.AuthLoginFailureAction:case m.AuthLogoutFailureAction:return g({},t,{loading:!1,errors:[e.errorMessage]});default:return t}}var G={loading:!1,errors:[]};function q(t,e){switch(void 0===t&&(t=G),e.type){case m.AuthRegisterAction:return g({},t,{loading:!0});case m.AuthRegisterSuccessAction:return g({},t,{loading:!1});case m.AuthRegisterFailureAction:return g({},t,{loading:!1,errors:[e.errorMessage]});default:return t}}var x,U={auth:M,login:P,register:q},N=function(){return x=x||e.createFeatureSelector("daffAuth")};var H=function(){var t=e.createSelector(N(),function(t){return t.auth});return{selectAuthState:t,selectAuthLoading:e.createSelector(t,function(t){return t.loading}),selectAuthErrors:e.createSelector(t,function(t){return t.errors})}},K=function(){var t;return function(){return t=t||H()}}();var V=function(){var t=e.createSelector(N(),function(t){return t.login}),r=e.createSelector(t,function(t){return t.loading}),n=e.createSelector(t,function(t){return t.errors}),o=e.createSelector(t,function(t){return t.auth});return{selectAuthLoginState:t,selectAuthLoginLoading:r,selectAuthLoginErrors:n,selectAuthLoginToken:o,selectAuthLoginTokenValue:e.createSelector(o,function(t){return t?t.token:null})}},z=function(){var t;return function(){return t=t||V()}}();var Y=function(){var t=e.createSelector(N(),function(t){return t.register});return{selectAuthRegisterState:t,selectAuthRegisterLoading:e.createSelector(t,function(t){return t.loading}),selectAuthRegisterErrors:e.createSelector(t,function(t){return t.errors})}},B=function(){var t;return function(){return t=t||Y()}}();var Z=function(){var t;return function(){return t=t||g({},K(),z(),B(),{selectAuthFeatureState:N()})}}(),J=function(){function t(t){this.store=t;var r=Z(),n=r.selectAuthLoginToken,o=r.selectAuthLoading,i=r.selectAuthErrors,a=r.selectAuthLoginLoading,u=r.selectAuthLoginErrors,c=r.selectAuthRegisterLoading,s=r.selectAuthRegisterErrors,f=r.selectAuthLoginTokenValue;this.auth$=this.store.pipe(e.select(n)),this.token$=this.store.pipe(e.select(f)),this.authLoading$=this.store.pipe(e.select(o)),this.authErrors$=this.store.pipe(e.select(i)),this.loginLoading$=this.store.pipe(e.select(a)),this.loginErrors$=this.store.pipe(e.select(u)),this.registerLoading$=this.store.pipe(e.select(c)),this.registerErrors$=this.store.pipe(e.select(s))}return t.prototype.dispatch=function(t){this.store.dispatch(t)},t.decorators=[{type:r.Injectable,args:[{providedIn:"root"}]}],t.ctorParameters=function(){return[{type:e.Store}]},t.ngInjectableDef=r.ɵɵdefineInjectable({factory:function(){return new t(r.ɵɵinject(e.Store))},token:t,providedIn:"root"}),t}();var Q=new r.InjectionToken("DaffRegisterDriver");var W=new r.InjectionToken("DaffLoginDriver");var X=new r.InjectionToken("DaffAuthDriver"),tt=function(){function t(t){this.storageService=t,this.AUTH_STORAGE_TOKEN="DAFF_AUTH_TOKEN"}return t.prototype.getAuthToken=function(){return this.storageService.getItem(this.AUTH_STORAGE_TOKEN)},t.prototype.setAuthToken=function(t){this.storageService.setItem(this.AUTH_STORAGE_TOKEN,t)},t.prototype.removeAuthToken=function(){this.storageService.removeItem(this.AUTH_STORAGE_TOKEN)},t.decorators=[{type:r.Injectable,args:[{providedIn:"root"}]}],t.ctorParameters=function(){return[{type:void 0,decorators:[{type:r.Inject,args:[u.DaffPersistenceServiceToken]}]}]},t.ngInjectableDef=r.ɵɵdefineInjectable({factory:function(){return new t(r.ɵɵinject(u.DaffPersistenceServiceToken))},token:t,providedIn:"root"}),t}();var et=function(){function t(t,e,r,n,u){var c=this;this.actions$=t,this.registerDriver=e,this.loginDriver=r,this.authDriver=n,this.storage=u,this.check$=this.actions$.pipe(o.ofType(m.AuthCheckAction),i.switchMap(function(t){return c.checkToken().pipe(i.mapTo(new L),i.catchError(function(t){return a.of(new $("Auth token is not valid"))}))})),this.login$=this.actions$.pipe(o.ofType(m.AuthLoginAction),i.switchMap(function(t){return c.loginDriver.login(t.loginInfo).pipe(i.map(function(t){return new I(t)}),i.catchError(function(t){return a.of(new T("Failed to log in"))}))})),this.storeAuthToken$=this.actions$.pipe(o.ofType(m.AuthLoginSuccessAction),i.tap(function(t){c.storage.setAuthToken(t.auth.token)}),i.switchMapTo(a.EMPTY),i.catchError(function(t){return a.of(new D("Storage of auth token has failed."))})),this.logout$=this.actions$.pipe(o.ofType(m.AuthLogoutAction),i.switchMap(function(t){return c.loginDriver.logout().pipe(i.mapTo(new j),i.catchError(function(t){return a.of(new b("Failed to log out"))}))})),this.loginAfterRegister$=this.actions$.pipe(o.ofType(m.AuthRegisterSuccessAction),i.map(function(t){return new S(t.loginInfo)})),this.register$=this.actions$.pipe(o.ofType(m.AuthRegisterAction),i.switchMap(function(t){return c.registerDriver.register(t.registration).pipe(i.map(function(t){return new R(t)}),i.catchError(function(t){return a.of(new F("Failed to register a new user"))}))})),this.guardCheck$=this.actions$.pipe(o.ofType(m.AuthGuardCheckAction),i.switchMap(function(t){return c.checkToken().pipe(i.mapTo(new k(!0)),i.catchError(function(t){return a.of(new k(!1))}))}))}return t.prototype.checkToken=function(){return this.authDriver.check()},t.decorators=[{type:r.Injectable}],t.ctorParameters=function(){return[{type:o.Actions},{type:void 0,decorators:[{type:r.Inject,args:[Q]}]},{type:void 0,decorators:[{type:r.Inject,args:[W]}]},{type:void 0,decorators:[{type:r.Inject,args:[X]}]},{type:tt}]},d([o.Effect(),A("design:type",a.Observable)],t.prototype,"check$",void 0),d([o.Effect(),A("design:type",a.Observable)],t.prototype,"login$",void 0),d([o.Effect({dispatch:!1}),A("design:type",Object)],t.prototype,"storeAuthToken$",void 0),d([o.Effect(),A("design:type",a.Observable)],t.prototype,"logout$",void 0),d([o.Effect(),A("design:type",a.Observable)],t.prototype,"loginAfterRegister$",void 0),d([o.Effect(),A("design:type",a.Observable)],t.prototype,"register$",void 0),d([o.Effect(),A("design:type",a.Observable)],t.prototype,"guardCheck$",void 0),t}();var rt,nt,ot,it,at=function(){function t(){}return t.decorators=[{type:r.NgModule,args:[{imports:[e.StoreModule.forFeature("daffAuth",U),o.EffectsModule.forFeature([et])]}]}],t}(),ut=function(){function t(){}return t.decorators=[{type:r.NgModule,args:[{imports:[n.CommonModule,at]}]}],t}(),ct=function(){function t(){}return t.prototype.transform=function(t){return{email:t.customer.email,password:t.password}},t.decorators=[{type:r.Injectable,args:[{providedIn:"root"}]}],t.ngInjectableDef=r.ɵɵdefineInjectable({factory:function(){return new t},token:t,providedIn:"root"}),t}(),st=s(rt||(rt=v(["\n  query CheckToken {\n    customer {\n      id\n    }\n  }\n"],["\n  query CheckToken {\n    customer {\n      id\n    }\n  }\n"]))),ft=s(nt||(nt=v(["\n  mutation CreateCustomer(\n    $email: String!,\n    $password: String!,\n    $firstname: String!,\n    $lastname: String!,\n  ) {\n    createCustomer(input: {\n      firstname: $firstname,\n      lastname: $lastname,\n      email: $email,\n      password: $password\n    })\n  }\n"],["\n  mutation CreateCustomer(\n    $email: String!,\n    $password: String!,\n    $firstname: String!,\n    $lastname: String!,\n  ) {\n    createCustomer(input: {\n      firstname: $firstname,\n      lastname: $lastname,\n      email: $email,\n      password: $password\n    })\n  }\n"]))),ht=s(ot||(ot=v(["\n  mutation GenerateToken($email: String!, $password: String!) {\n    generateCustomerToken(\n      email: $email,\n      password: $password\n    ) {\n      token\n    }\n  }\n"],["\n  mutation GenerateToken($email: String!, $password: String!) {\n    generateCustomerToken(\n      email: $email,\n      password: $password\n    ) {\n      token\n    }\n  }\n"]))),lt=s(it||(it=v(["\n  mutation revokeCustomerToken {\n    revokeCustomerToken {\n      result\n    }\n  }\n"],["\n  mutation revokeCustomerToken {\n    revokeCustomerToken {\n      result\n    }\n  }\n"]))),pt="graphql-authorization",gt="graphql-authentication",dt="graphql-input",At=function(t){function e(e){var r=t.call(this,e)||this;return r.message=e,r.code="DAFF_AUTH_UNAUTHORIZED",r}return p(e,t),e}(u.DaffInheritableError);var vt=function(t){function e(e){var r=t.call(this,e)||this;return r.message=e,r.code="DAFF_AUTH_AUTHENTICATION_FAILED",r}return p(e,t),e}(u.DaffInheritableError);var mt,yt=function(t){function e(e){var r=t.call(this,e)||this;return r.message=e,r.code="DAFF_AUTH_INVALID_API_RESPONSE",r}return p(e,t),e}(u.DaffInheritableError);var kt=((mt={})[pt]=At,mt[gt]=vt,mt[dt]=h.DaffBadInputError,mt),Dt=function(t){return f.daffTransformMagentoError(t,kt)},St=function(){function t(t,e){this.apollo=t,this.loginInfoTransformer=e}return t.prototype.register=function(t){return this.apollo.mutate({mutation:ft,variables:{email:t.customer.email,password:t.password,firstname:t.customer.firstName,lastname:t.customer.lastName}}).pipe(i.mapTo(this.loginInfoTransformer.transform(t)),i.catchError(function(t){return a.throwError(Dt(t))}))},t.decorators=[{type:r.Injectable,args:[{providedIn:"root"}]}],t.ctorParameters=function(){return[{type:c.Apollo},{type:ct}]},t.ngInjectableDef=r.ɵɵdefineInjectable({factory:function(){return new t(r.ɵɵinject(c.Apollo),r.ɵɵinject(ct))},token:t,providedIn:"root"}),t}();var It=function(){function t(){}return t.prototype.transform=function(t){return{token:t.token}},t.decorators=[{type:r.Injectable,args:[{providedIn:"root"}]}],t.ngInjectableDef=r.ɵɵdefineInjectable({factory:function(){return new t},token:t,providedIn:"root"}),t}(),Tt=function(t){if(t.data.customer.id)return t;throw new yt("Check token response does not contain a valid customer ID.")},wt=function(t){if(t.data.generateCustomerToken.token)return t;throw new yt("Generate token response does not contain an auth token.")},jt=function(t){if(t.data.revokeCustomerToken.result)return t;throw new yt("Revoke token response does not contain a successful result.")},bt=function(){function t(t,e){this.apollo=t,this.authTransformer=e}return t.prototype.login=function(t){var e=this,r=t.email,n=t.password;return this.apollo.mutate({mutation:ht,variables:{email:r,password:n}}).pipe(i.map(wt),i.map(function(t){return e.authTransformer.transform(t.data.generateCustomerToken)}),i.catchError(function(t){return a.throwError(Dt(t))}))},t.prototype.logout=function(){return this.apollo.mutate({mutation:lt}).pipe(i.map(jt),i.mapTo(void 0),i.catchError(function(t){return a.throwError(Dt(t))}))},t.decorators=[{type:r.Injectable,args:[{providedIn:"root"}]}],t.ctorParameters=function(){return[{type:c.Apollo},{type:It}]},t.ngInjectableDef=r.ɵɵdefineInjectable({factory:function(){return new t(r.ɵɵinject(c.Apollo),r.ɵɵinject(It))},token:t,providedIn:"root"}),t}();var Et=function(){function t(t){this.apollo=t}return t.prototype.check=function(){return this.apollo.query({query:st}).pipe(i.map(Tt),i.mapTo(void 0),i.catchError(function(t){return a.throwError(Dt(t))}))},t.decorators=[{type:r.Injectable,args:[{providedIn:"root"}]}],t.ctorParameters=function(){return[{type:c.Apollo}]},t.ngInjectableDef=r.ɵɵdefineInjectable({factory:function(){return new t(r.ɵɵinject(c.Apollo))},token:t,providedIn:"root"}),t}();var Lt=function(){function t(){}return t.forRoot=function(){return{ngModule:t,providers:[{provide:Q,useExisting:St},{provide:W,useExisting:bt},{provide:X,useExisting:Et}]}},t.decorators=[{type:r.NgModule,args:[{imports:[n.CommonModule]}]}],t}(),$t=function(){function t(t,e){this.facade=t,this.actions$=e}return t.prototype.canActivate=function(){var t=this.isAuthenticated();return this.facade.dispatch(new y),t},t.prototype.isAuthenticated=function(){return this.actions$.pipe(o.ofType(m.AuthGuardCheckCompletionAction),i.map(function(t){return t.result}))},t.decorators=[{type:r.Injectable,args:[{providedIn:"root"}]}],t.ctorParameters=function(){return[{type:J},{type:o.Actions}]},t.ngInjectableDef=r.ɵɵdefineInjectable({factory:function(){return new t(r.ɵɵinject(J),r.ɵɵinject(o.Actions))},token:t,providedIn:"root"}),t}();var Ct=function(){function t(t,e){this.facade=t,this.memberOnlyGuard=e}return t.prototype.canActivate=function(){var t=this.isUnauthenticated();return this.facade.dispatch(new y),t},t.prototype.isUnauthenticated=function(){return this.memberOnlyGuard.isAuthenticated().pipe(i.map(function(t){return!t}))},t.decorators=[{type:r.Injectable,args:[{providedIn:"root"}]}],t.ctorParameters=function(){return[{type:J},{type:$t}]},t.ngInjectableDef=r.ɵɵdefineInjectable({factory:function(){return new t(r.ɵɵinject(J),r.ɵɵinject($t))},token:t,providedIn:"root"}),t}();t.DAFF_AUTH_STORE_FEATURE_KEY="daffAuth",t.DaffAuthActionTypes=m,t.DaffAuthCheck=E,t.DaffAuthCheckFailure=$,t.DaffAuthCheckSuccess=L,t.DaffAuthDriver=X,t.DaffAuthFacade=J,t.DaffAuthGuardCheck=y,t.DaffAuthGuardCheckCompletion=k,t.DaffAuthInvalidAPIResponseError=yt,t.DaffAuthLogin=S,t.DaffAuthLoginFailure=T,t.DaffAuthLoginSuccess=I,t.DaffAuthLogout=w,t.DaffAuthLogoutFailure=b,t.DaffAuthLogoutSuccess=j,t.DaffAuthMagentoDriverModule=Lt,t.DaffAuthModule=ut,t.DaffAuthRegister=C,t.DaffAuthRegisterFailure=F,t.DaffAuthRegisterSuccess=R,t.DaffAuthStorageFailure=D,t.DaffAuthStorageService=tt,t.DaffAuthenticationFailedError=vt,t.DaffLoginDriver=W,t.DaffMagentoAuthService=Et,t.DaffMagentoAuthTransformerService=It,t.DaffMagentoLoginInfoTransformerService=ct,t.DaffMagentoLoginService=bt,t.DaffMagentoRegisterService=St,t.DaffRegisterDriver=Q,t.DaffUnauthorizedError=At,t.GuestOnlyGuard=Ct,t.MemberOnlyGuard=$t,t.daffAuthInitialState=O,t.daffAuthLoginInitialState=_,t.daffAuthLoginReducer=P,t.daffAuthReducer=M,t.daffAuthReducers=U,t.daffAuthRegisterInitialState=G,t.daffAuthRegisterReducer=q,t.getDaffAuthSelectors=Z,t.ɵa=at,t.ɵb=et,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=daffodil-auth.umd.min.js.map