{"version":3,"file":"daffodil-core-graphql.js","sources":["ng://@daffodil/core/graphql/fragments/build-fragment-name-spread.ts","ng://@daffodil/core/graphql/fragments/build-fragment-definition.ts","ng://@daffodil/core/graphql/apollo/queued-apollo.service.ts"],"sourcesContent":["import { DocumentNode, FragmentDefinitionNode } from 'graphql'\n\nconst getFragmentNames = (fragment: DocumentNode) =>\n  fragment.definitions.filter(def =>\n    def.kind === 'FragmentDefinition'\n  ).map(def =>\n    (def as FragmentDefinitionNode).name.value\n  )\n\n/**\n * Builds a list of fragment names present inside the specified GraphQL document nodes.\n * Returns an empty array if no fragments have been defined or if null is passed.\n * @param fragments The created fragments.\n */\nconst daffGetFragmentNames = (...fragments: DocumentNode[]): string[] =>\n  fragments.reduce((acc, fragment) => acc.concat(getFragmentNames(fragment)), [])\n\n/**\n * Builds a string of fragment names that can be interpolated into a GraphQL query.\n * Each name is separated by a newline character: '\\n'.\n * If an empty array is passed, an empty string is returned.\n * @param fragments A list of GraphQL documents that contain fragments.\n */\nexport const daffBuildFragmentNameSpread = (...fragments: DocumentNode[]): string =>\n  daffGetFragmentNames(...fragments).reduce((acc, name) => acc.concat(`...${name}\\n`), '')\n","import { DocumentNode } from 'graphql'\n\n/**\n * Builds a string of fragment definitions that can be interpolated into a GraphQL query.\n * Each definition is separated by a newline character: '\\n'.\n * @param documents A list of GraphQL documents that should only contain fragments.\n */\nexport const daffBuildFragmentDefinition = (...documents: DocumentNode[]): string =>\n  documents.reduce((acc, fragment) => acc.concat(`${fragment.loc.source.body}\\n`), '')\n","import { Injectable } from '@angular/core';\nimport { Apollo } from 'apollo-angular';\nimport { R } from 'apollo-angular/types';\nimport { MutationOptions } from 'apollo-client';\nimport { FetchResult } from 'apollo-link';\nimport { Observable, Subscriber, Subscription } from 'rxjs';\n\n/**\n * A service that will queue mutate calls to Apollo.\n * It will not send subsequent mutate requests until the previous one has been completed.\n * This is useful for avoiding race conditions on the backend.\n * This should be used alongside Apollo.\n */\n@Injectable({\n  providedIn: 'root'\n})\nexport class DaffQueuedApollo {\n  queue: Function[] = [];\n\n  constructor(\n    private apollo: Apollo\n  ) {}\n\n  /**\n   * Queue up a mutate request.\n   * The request will not actually be queued until the returned observable is subscribed.\n   * If the queue is empty, the request will be sent when it enters the queue.\n   * Otherwise, it will be sent when it reaches the front of the queue.\n   * The observable will complete after it emits once.\n   * @param options Mutation options.\n   */\n  mutate<T, V = R>(options: MutationOptions<T, V>): Observable<FetchResult<T>> {\n    return new Observable(subscriber => this.addRequestToQueue(subscriber, this.apollo.mutate(options)))\n  }\n\n  private addRequestToQueue(subscriber: Subscriber<any>, request: Observable<any>): void {\n    this.queue.push(() => {\n      const sub = request.subscribe(\n        response => {\n          // emit the outer observable\n          subscriber.next(response);\n          subscriber.complete();\n\n          this.finishRequestSubscription(sub);\n        },\n        error => {\n          subscriber.error(error)\n          this.finishRequestSubscription(sub);\n        },\n        () => {\n          subscriber.complete()\n          this.finishRequestSubscription(sub);\n        }\n      )\n    });\n\n    // start the queue if previously empty\n    if (this.queue.length === 1) this.queue[0]();\n  }\n\n  private finishRequestSubscription(requestSubscription: Subscription): void {\n    requestSubscription.unsubscribe();\n\n    // process queue\n    this.queue.shift();\n    // TODO: optional chaining\n    if (this.queue[0]) this.queue[0]();\n  }\n}\n"],"names":[],"mappings":"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"}