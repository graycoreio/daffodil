{"version":3,"file":"daffodil-navigation-driver-magento.js","sources":["ng://@daffodil/navigation/driver/magento/interfaces/navigation-config.interface.ts","ng://@daffodil/navigation/driver/magento/queries/fragments/category-node.ts","ng://@daffodil/navigation/driver/magento/queries/get-category-tree.ts","ng://@daffodil/navigation/driver/magento/navigation.service.ts","ng://@daffodil/navigation/driver/magento/transformers/navigation-transformer.ts","ng://@daffodil/navigation/driver/magento/navigation-driver.module.ts"],"sourcesContent":["import { InjectionToken } from '@angular/core';\n\n/**\n * The maximum depth of category children that the navigation driver will query.\n * Defaults to 3.\n */\nexport const MAGENTO_NAVIGATION_TREE_QUERY_DEPTH =\n  new InjectionToken<number>('MAGENTO_NAVIGATION_TREE_QUERY_DEPTH', {factory: () => 3});\n\nexport interface MagentoNavigationDriverConfiguration {\n  navigationTreeQueryDepth: number;\n}\n","import { DocumentNode } from 'graphql';\nimport gql from 'graphql-tag';\n\n/**\n * A category tree fragment with no nested children.\n */\nconst categoryNodeFragment = `\n\tid\n\tlevel\n\tname\n\tinclude_in_menu\n\tbreadcrumbs {\n\t\tcategory_id\n\t\tcategory_name\n\t\tcategory_level\n\t\tcategory_url_key\n\t}\n\tproduct_count\n`\n\n/**\n * Generates a category tree fragment with the specified number of nested child category trees.\n * @param depth The maximum depth to which category children should be added to the fragment.\n */\n//todo: use nested fragments when this bug is fixed: https://github.com/magento/magento2/issues/31086\nexport function getCategoryNodeFragment(depth: number = 3): DocumentNode {\n  const fragmentBody = new Array(depth).fill(null).reduce(acc => `\n    ${categoryNodeFragment}\n    children_count\n    children {\n      ${acc}\n    }\n  `, categoryNodeFragment)\n\n  return gql`\n    fragment recursiveCategoryNode on CategoryTree {\n      ${fragmentBody}\n    }\n  `\n}\n","import gql from 'graphql-tag';\n\nimport { getCategoryNodeFragment } from './fragments/category-node';\n\n/**\n * Generates a category tree query with the specified number of nested child category tree fragments.\n * @param depth The maximum depth to which category children should be added to the fragment.\n */\nexport function daffMagentoGetCategoryTree(depth: number = 3) {\n  return gql`\n    query GetCategoryTree($filters: CategoryFilterInput!){\n      categoryList(filters: $filters) {\n        ...recursiveCategoryNode\n      }\n    }\n    ${getCategoryNodeFragment(depth)}\n  `;\n}\n","import { Injectable, Inject } from '@angular/core';\nimport { Observable } from 'rxjs';\nimport { map } from 'rxjs/operators';\nimport { Apollo } from 'apollo-angular';\n\nimport { DaffNavigationTree } from '@daffodil/navigation';\nimport {\n  DaffNavigationTransformer,\n  DaffNavigationServiceInterface,\n  DaffNavigationTransformerInterface\n} from '@daffodil/navigation/driver';\n\nimport { daffMagentoGetCategoryTree } from './queries/get-category-tree';\nimport { GetCategoryTreeResponse } from './models/get-category-tree-response';\nimport { MAGENTO_NAVIGATION_TREE_QUERY_DEPTH } from './interfaces/navigation-config.interface';\n\n@Injectable({\n  providedIn: 'root'\n})\nexport class DaffMagentoNavigationService implements DaffNavigationServiceInterface<DaffNavigationTree> {\n\n  constructor(\n    private apollo: Apollo,\n    @Inject(DaffNavigationTransformer) private transformer: DaffNavigationTransformerInterface<DaffNavigationTree>,\n    @Inject(MAGENTO_NAVIGATION_TREE_QUERY_DEPTH) private categoryTreeQueryDepth: number\n  ) {}\n\n  get(categoryId: string): Observable<DaffNavigationTree> {\n    return this.apollo.query<GetCategoryTreeResponse>({\n      query: daffMagentoGetCategoryTree(this.categoryTreeQueryDepth),\n      variables: {\n        filters: { ids: { eq: categoryId } }\n      }\n    }).pipe(\n      map(result => this.transformer.transform(result.data.categoryList[0]))\n    );\n  }\n}\n","import { Injectable } from '@angular/core';\n\nimport { DaffNavigationBreadcrumb, DaffNavigationTree } from '@daffodil/navigation';\nimport { DaffNavigationTransformerInterface } from '@daffodil/navigation/driver';\n\nimport { CategoryNode, MagentoBreadcrumb } from '../models/category-node';\n\n@Injectable({\n  providedIn: 'root'\n})\nexport class DaffMagentoNavigationTransformerService implements DaffNavigationTransformerInterface<DaffNavigationTree> {\n\n  transform(node: CategoryNode): DaffNavigationTree {\n    return {\n      id: node.id,\n      path: node.id,\n      name: node.name,\n      total_products: node.product_count,\n      children_count: node.children_count,\n\t\t\t//todo: use optional chaining when possible\n\t\t\tbreadcrumbs: node.breadcrumbs ? \n\t\t\t\tnode.breadcrumbs\n\t\t\t\t\t.map(breadcrumb => this.transformBreadcrumb(breadcrumb))\n\t\t\t\t\t.sort((a, b) => a.categoryLevel - b.categoryLevel) : \n\t\t\t\t[],\n      // TODO: optional chaining\n      children: node.children && node.children.filter(child => child.include_in_menu).map(child => this.transform(child))\n    };\n  }\n\n  private transformBreadcrumb(breadcrumb: MagentoBreadcrumb): DaffNavigationBreadcrumb {\n    return {\n      categoryId: breadcrumb.category_id,\n      categoryName: breadcrumb.category_name,\n      categoryLevel: breadcrumb.category_level,\n      categoryUrlKey: breadcrumb.category_url_key\n    }\n  }\n}\n","import { NgModule, ModuleWithProviders } from '@angular/core';\nimport { CommonModule } from '@angular/common';\n\nimport {\n  DaffNavigationDriver,\n  DaffNavigationTransformer,\n} from '@daffodil/navigation/driver';\n\nimport { DaffMagentoNavigationService } from './navigation.service';\nimport { DaffMagentoNavigationTransformerService } from './transformers/navigation-transformer';\nimport { MagentoNavigationDriverConfiguration, MAGENTO_NAVIGATION_TREE_QUERY_DEPTH } from './interfaces/navigation-config.interface';\n\nexport const MAGENTO_NAVIGATION_DEFAULT_CONFIGURATION: MagentoNavigationDriverConfiguration = {\n  navigationTreeQueryDepth: 3\n}\n\n@NgModule({\n  imports: [\n    CommonModule\n  ]\n})\nexport class DaffNavigationMagentoDriverModule {\n  static forRoot(config: MagentoNavigationDriverConfiguration = MAGENTO_NAVIGATION_DEFAULT_CONFIGURATION): ModuleWithProviders<DaffNavigationMagentoDriverModule> {\n    return {\n      ngModule: DaffNavigationMagentoDriverModule,\n      providers: [\n        {\n          provide: DaffNavigationDriver,\n          useExisting: DaffMagentoNavigationService\n        },\n        {\n          provide: DaffNavigationTransformer,\n          useExisting: DaffMagentoNavigationTransformerService\n        },\n        {\n          provide: MAGENTO_NAVIGATION_TREE_QUERY_DEPTH,\n          useValue: config.navigationTreeQueryDepth\n        }\n      ]\n    };\n  }\n}\n"],"names":[],"mappings":";;;;;;;;;;;AAAA;;;;;AAMA,MAAa,mCAAmC,GAC9C,IAAI,cAAc,CAAS,qCAAqC,EAAE,EAAC,OAAO;;;IAAE,MAAM,CAAC,CAAA,EAAC,CAAC;;;;AAEvF,mDAEC;;;IADC,wEAAiC;;;;;;;ACTnC;;;;MAKM,oBAAoB,GAAG;;;;;;;;;;;;CAY5B;;;;;;;;;;;;;AAOD,SAAgB,uBAAuB,CAAC,QAAgB,CAAC;;UACjD,YAAY,GAAG,IAAI,KAAK,CAAC,KAAK,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,MAAM;;;;IAAC,GAAG,IAAI;MAC3D,oBAAoB;;;QAGlB,GAAG;;GAER,GAAE,oBAAoB,CAAC;IAExB,OAAO,GAAG,CAAA;;QAEJ,YAAY;;GAEjB,CAAA;CACF;;;;;;ACvCD;;;;;AAQA,SAAgB,0BAA0B,CAAC,QAAgB,CAAC;IAC1D,OAAO,GAAG,CAAA;;;;;;MAMN,uBAAuB,CAAC,KAAK,CAAC;GACjC,CAAC;CACH;;;;;;ACjBD,MAmBa,4BAA4B;;;;;;IAEvC,YACU,MAAc,EACqB,WAAmE,EACzD,sBAA8B;QAF3E,WAAM,GAAN,MAAM,CAAQ;QACqB,gBAAW,GAAX,WAAW,CAAwD;QACzD,2BAAsB,GAAtB,sBAAsB,CAAQ;KACjF;;;;;IAEJ,GAAG,CAAC,UAAkB;QACpB,OAAO,IAAI,CAAC,MAAM,CAAC,KAAK,CAA0B;YAChD,KAAK,EAAE,0BAA0B,CAAC,IAAI,CAAC,sBAAsB,CAAC;YAC9D,SAAS,EAAE;gBACT,OAAO,EAAE,EAAE,GAAG,EAAE,EAAE,EAAE,EAAE,UAAU,EAAE,EAAE;aACrC;SACF,CAAC,CAAC,IAAI,CACL,GAAG;;;;QAAC,MAAM,IAAI,IAAI,CAAC,WAAW,CAAC,SAAS,CAAC,MAAM,CAAC,IAAI,CAAC,YAAY,CAAC,CAAC,CAAC,CAAC,EAAC,CACvE,CAAC;KACH;;;YApBF,UAAU,SAAC;gBACV,UAAU,EAAE,MAAM;aACnB;;;;YAfQ,MAAM;4CAoBV,MAAM,SAAC,yBAAyB;yCAChC,MAAM,SAAC,mCAAmC;;;;;;;;IAF3C,8CAAsB;;;;;IACtB,mDAA8G;;;;;IAC9G,8DAAmF;;;;;;;ACxBvF,MAUa,uCAAuC;;;;;IAElD,SAAS,CAAC,IAAkB;QAC1B,OAAO;YACL,EAAE,EAAE,IAAI,CAAC,EAAE;YACX,IAAI,EAAE,IAAI,CAAC,EAAE;YACb,IAAI,EAAE,IAAI,CAAC,IAAI;YACf,cAAc,EAAE,IAAI,CAAC,aAAa;YAClC,cAAc,EAAE,IAAI,CAAC,cAAc;;YAEtC,WAAW,EAAE,IAAI,CAAC,WAAW;gBAC5B,IAAI,CAAC,WAAW;qBACd,GAAG;;;;gBAAC,UAAU,IAAI,IAAI,CAAC,mBAAmB,CAAC,UAAU,CAAC,EAAC;qBACvD,IAAI;;;;;gBAAC,CAAC,CAAC,EAAE,CAAC,KAAK,CAAC,CAAC,aAAa,GAAG,CAAC,CAAC,aAAa,EAAC;gBACnD,EAAE;;YAEA,QAAQ,EAAE,IAAI,CAAC,QAAQ,IAAI,IAAI,CAAC,QAAQ,CAAC,MAAM;;;;YAAC,KAAK,IAAI,KAAK,CAAC,eAAe,EAAC,CAAC,GAAG;;;;YAAC,KAAK,IAAI,IAAI,CAAC,SAAS,CAAC,KAAK,CAAC,EAAC;SACpH,CAAC;KACH;;;;;;IAEO,mBAAmB,CAAC,UAA6B;QACvD,OAAO;YACL,UAAU,EAAE,UAAU,CAAC,WAAW;YAClC,YAAY,EAAE,UAAU,CAAC,aAAa;YACtC,aAAa,EAAE,UAAU,CAAC,cAAc;YACxC,cAAc,EAAE,UAAU,CAAC,gBAAgB;SAC5C,CAAA;KACF;;;YA9BF,UAAU,SAAC;gBACV,UAAU,EAAE,MAAM;aACnB;;;;;;;;ACTD;AAYA,MAAa,wCAAwC,GAAyC;IAC5F,wBAAwB,EAAE,CAAC;CAC5B;AAOD,MAAa,iCAAiC;;;;;IAC5C,OAAO,OAAO,CAAC,SAA+C,wCAAwC;QACpG,OAAO;YACL,QAAQ,EAAE,iCAAiC;YAC3C,SAAS,EAAE;gBACT;oBACE,OAAO,EAAE,oBAAoB;oBAC7B,WAAW,EAAE,4BAA4B;iBAC1C;gBACD;oBACE,OAAO,EAAE,yBAAyB;oBAClC,WAAW,EAAE,uCAAuC;iBACrD;gBACD;oBACE,OAAO,EAAE,mCAAmC;oBAC5C,QAAQ,EAAE,MAAM,CAAC,wBAAwB;iBAC1C;aACF;SACF,CAAC;KACH;;;YAxBF,QAAQ,SAAC;gBACR,OAAO,EAAE;oBACP,YAAY;iBACb;aACF;;;;;;;;;;;;;;;;;;;;;;;;;"}